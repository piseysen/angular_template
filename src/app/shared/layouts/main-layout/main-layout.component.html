<div class="main-layout-container">
  <!-- Environment Indicator -->
  @if(environmentService.isDebugMode) {
    <app-environment-indicator></app-environment-indicator>
  }
  
  <!-- Main Layout -->
  <mat-sidenav-container class="sidenav-container">
    <!-- Enhanced Sidenav -->
    <mat-sidenav
      #sidenav
      [mode]="sidenavMode()"
      [opened]="!isHandset()"
      class="enhanced-sidenav"
      [class.collapsed]="isSidenavCollapsed() && !isHandset()"
    >
      <!-- Sidenav Header -->
      <div class="sidenav-header">
        <div class="logo-section" [class.collapsed]="isSidenavCollapsed() && !isHandset()">
          <div class="logo-container">
            <div class="logo-icon">
              <mat-icon>business</mat-icon>
            </div>
            @if (!isSidenavCollapsed() || isHandset()) {
              <div class="logo-text">
                <h2>Admin Panel</h2>
                <p>Management System</p>
              </div>
            }
          </div>
          
          @if (!isHandset()) {
            <button 
              mat-icon-button 
              (click)="toggleSidenav()" 
              class="collapse-btn"
              [matTooltip]="isSidenavCollapsed() ? 'Expand sidebar' : 'Collapse sidebar'"
              matTooltipPosition="right"
            >
              <mat-icon>{{ isSidenavCollapsed() ? 'chevron_right' : 'chevron_left' }}</mat-icon>
            </button>
          }
        </div>
      </div>

      <!-- Navigation Menu -->
      <div class="navigation-section">
        <div class="nav-group">
          <div class="nav-group-header" [class.collapsed]="isSidenavCollapsed() && !isHandset()">
            @if (!isSidenavCollapsed() || isHandset()) {
              <span>Main Menu</span>
            }
          </div>
          
          <mat-nav-list class="nav-list">
            @for (item of menuItems; track item.route) {
              <mat-list-item 
                class="nav-item" 
                [routerLink]="item.route" 
                routerLinkActive="active"
                [matTooltip]="(isSidenavCollapsed() && !isHandset()) ? item.tooltip : ''"
                matTooltipPosition="right"
                (click)="closeSidenav()"
              >
                <mat-icon matListItemIcon [matBadge]="item.badge" [matBadgeHidden]="!item.badge" 
                          matBadgeColor="accent" matBadgeSize="small">
                  {{ item.icon }}
                </mat-icon>
                @if (!isSidenavCollapsed() || isHandset()) {
                  <ng-container matListItemTitle>{{ item.label }}</ng-container>
                }
                @if (item.badge && typeof item.badge === 'number' && (!isSidenavCollapsed() || isHandset())) {
                  <span class="item-badge">{{ item.badge }}</span>
                } @else if (item.badge === 'new' && (!isSidenavCollapsed() || isHandset())) {
                  <span class="item-badge new">NEW</span>
                }
              </mat-list-item>
            }
          </mat-nav-list>
        </div>

        <!-- User Section -->
        <div class="nav-group user-section">
          <div class="nav-group-header" [class.collapsed]="isSidenavCollapsed() && !isHandset()">
            @if (!isSidenavCollapsed() || isHandset()) {
              <span>Account</span>
            }
          </div>
          
          <mat-nav-list class="nav-list">
            @for (item of userMenuItems; track item.route) {
              <mat-list-item 
                class="nav-item" 
                [routerLink]="item.route" 
                routerLinkActive="active"
                [matTooltip]="(isSidenavCollapsed() && !isHandset()) ? item.label : ''"
                matTooltipPosition="right"
                (click)="closeSidenav()"
              >
                <mat-icon matListItemIcon>{{ item.icon }}</mat-icon>
                @if (!isSidenavCollapsed() || isHandset()) {
                  <ng-container matListItemTitle>{{ item.label }}</ng-container>
                }
              </mat-list-item>
            }
            
            <mat-divider class="nav-divider"></mat-divider>
            
            <mat-list-item 
              class="nav-item logout-item" 
              (click)="logout()"
              [matTooltip]="(isSidenavCollapsed() && !isHandset()) ? 'Logout' : ''"
              matTooltipPosition="right"
            >
              <mat-icon matListItemIcon>logout</mat-icon>
              @if (!isSidenavCollapsed() || isHandset()) {
                <ng-container matListItemTitle>Logout</ng-container>
              }
            </mat-list-item>
          </mat-nav-list>
        </div>
      </div>

      <!-- User Profile at Bottom (when expanded) -->
      @if (!isSidenavCollapsed() || isHandset()) {
        <div class="user-profile-section">
          <div class="user-profile-card">
            <div class="user-avatar">
              @if (authService.user()?.avatar) {
                <img [src]="authService.user()?.avatar" [alt]="authService.user()?.firstName" />
              } @else {
                <mat-icon>account_circle</mat-icon>
              }
            </div>
            <div class="user-info">
              <div class="user-name">{{ authService.user()?.firstName }} {{ authService.user()?.lastName }}</div>
              <div class="user-role">Administrator</div>
            </div>
          </div>
        </div>
      }
    </mat-sidenav>

    <!-- Main Content -->
    <mat-sidenav-content class="main-content">
      <!-- Enhanced Toolbar -->
      <mat-toolbar class="enhanced-toolbar">
        <div class="toolbar-left">
          @if (isHandset()) {
            <button
              mat-icon-button
              (click)="toggleSidenav()"
              class="menu-toggle-btn"
              matTooltip="Open menu"
            >
              <mat-icon>menu</mat-icon>
            </button>
          } @else if (!isSidenavCollapsed()) {
            <button
              mat-icon-button
              (click)="toggleSidenav()"
              class="menu-toggle-btn"
              matTooltip="Collapse sidebar"
            >
              <mat-icon>menu_open</mat-icon>
            </button>
          }
          
          <div class="page-title">
            <h1>{{ authService.user()?.firstName ? 'Welcome, ' + authService.user()?.firstName : 'Dashboard' }}</h1>
          </div>
        </div>

        <div class="toolbar-right">
          <!-- Quick Actions -->
          <button
            mat-icon-button
            class="action-btn"
            matTooltip="Notifications"
            [matBadge]="3"
            matBadgeColor="warn"
            matBadgeSize="small"
          >
            <mat-icon>notifications</mat-icon>
          </button>
          
          <button
            mat-icon-button
            class="action-btn"
            matTooltip="Messages"
            [matBadge]="5"
            matBadgeColor="accent"
            matBadgeSize="small"
          >
            <mat-icon>mail</mat-icon>
          </button>

          <button
            mat-icon-button
            class="action-btn"
            matTooltip="Search"
          >
            <mat-icon>search</mat-icon>
          </button>

          <!-- User Menu -->
          <button
            mat-button
            [matMenuTriggerFor]="userMenu"
            class="user-menu-trigger"
          >
            <div class="user-avatar-small">
              @if (authService.user()?.avatar) {
                <img [src]="authService.user()?.avatar" [alt]="authService.user()?.firstName" />
              } @else {
                <mat-icon>account_circle</mat-icon>
              }
            </div>
            <!-- <span class="user-name-toolbar">{{ authService.user()?.firstName }}</span> -->
            <mat-icon class="dropdown-arrow">keyboard_arrow_down</mat-icon>
          </button>

          <mat-menu #userMenu="matMenu" class="enhanced-user-menu">
            <div class="user-menu-header">
              <div class="user-avatar-menu">
                @if (authService.user()?.avatar) {
                  <img [src]="authService.user()?.avatar" [alt]="authService.user()?.firstName" />
                } @else {
                  <mat-icon>account_circle</mat-icon>
                }
              </div>
              <div class="user-info-menu">
                <div class="user-name">{{ authService.user()?.firstName }} {{ authService.user()?.lastName }}</div>
                <div class="user-email">{{ authService.user()?.email }}</div>
              </div>
            </div>
            
            <mat-divider></mat-divider>
            
            <button mat-menu-item [routerLink]="['/profile']">
              <mat-icon>person</mat-icon>
              <span>My Profile</span>
            </button>
            
            <button mat-menu-item [routerLink]="['/settings']">
              <mat-icon>settings</mat-icon>
              <span>Settings</span>
            </button>
            
            <button mat-menu-item>
              <mat-icon>help</mat-icon>
              <span>Help & Support</span>
            </button>
            
            <mat-divider></mat-divider>
            
            <button mat-menu-item (click)="logout()" class="logout-menu-item">
              <mat-icon>logout</mat-icon>
              <span>Sign Out</span>
            </button>
          </mat-menu>
        </div>
      </mat-toolbar>

      <!-- Page Content -->
      <div class="page-content">
        <div class="content-wrapper">
          <router-outlet></router-outlet>
        </div>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>
</div>
